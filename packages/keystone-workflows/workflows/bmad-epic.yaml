$schema: https://raw.githubusercontent.com/mhingston/keystone-cli/main/schemas/workflow.json
name: bmad-epic
description: "BMAD epic iterator: Parse sprint-status.yaml and process all stories in an epic using native foreach"

inputs:
  epic_id:
    type: string
    description: "Epic ID prefix (e.g., 'env-1')"
  sprint_status_path:
    type: string
    default: "_bmad-output/implementation-artifacts/sprint-status.yaml"
    description: "Path to sprint-status.yaml file"
  use_tea:
    type: boolean
    default: false
    description: "Enable TEA (Test-Evidence-Architecture) steps in story workflows"

outputs:
  result: ${{ steps.summary.output }}

steps:
  # parseStories - Parse sprint-status.yaml and output JSON array
  - id: parseStories
    type: shell
    allowInsecure: true
    run: |
      EPIC_ID="${{ inputs.epic_id }}"
      SPRINT_STATUS="${{ inputs.sprint_status_path }}"

      if [ ! -f "$SPRINT_STATUS" ]; then
        printf "Error: Sprint status file not found at %s\n" "$SPRINT_STATUS" >&2
        exit 1
      fi

      # Extract story IDs and write to temp file for script to read
      STORIES=$(grep -E "^  ${EPIC_ID}-[0-9]+" "$SPRINT_STATUS" 2>/dev/null | grep -vE ': done(\s|$)' | sed 's/:.*//' | tr -d ' ')

      if [ -z "$STORIES" ]; then
        printf "Error: No stories found for epic %s in %s\n" "$EPIC_ID" "$SPRINT_STATUS" >&2
        exit 1
      fi

      # Write as JSON array to dynamic temp file
      TMPFILE=$(mktemp /tmp/keystone-stories.XXXXXX.json)
      if [ -z "$TMPFILE" ]; then
        printf "Error: Failed to create temporary file\n" >&2
        exit 1
      fi
      printf '[' > "$TMPFILE"
      FIRST=true
      printf '%s\n' "$STORIES" | while IFS= read -r story; do
        if [ "$FIRST" = "true" ]; then
          FIRST=false
        else
          printf ',' >> "$TMPFILE"
        fi
        printf '"%s"' "$story" >> "$TMPFILE"
      done
      printf ']' >> "$TMPFILE"

      # Output the temp file path
      printf '%s' "$TMPFILE"

  # loadStories - Read the JSON and return as array
  - id: loadStories
    type: script
    allowInsecure: true
    needs: [parseStories]
    run: |
      const fs = require("fs");
      const tmpFile = "${{ steps.parseStories.output }}";

      try {
        if (!fs.existsSync(tmpFile)) {
          throw new Error("Temp file not found: " + tmpFile);
        }
        const content = fs.readFileSync(tmpFile, "utf8");
        const result = JSON.parse(content);
        fs.unlinkSync(tmpFile);
        return result;
      } catch (error) {
        // Ensure cleanup even on error
        if (fs.existsSync(tmpFile)) {
          fs.unlinkSync(tmpFile);
        }
        throw error;
      }

  # confirmStart - Confirm before processing
  - id: confirmStart
    type: human
    needs: [loadStories]
    message: |
      Ready to process Epic ${{ inputs.epic_id }}

      Stories to process:
      ${{ steps.loadStories.output }}

      Start processing?
    inputType: confirm

  # promptArchitectureValidation - Validate architecture (optional)
  - id: promptArchitectureValidation
    type: human
    needs: [confirmStart]
    if: ${{ steps.confirmStart.output == true }}
    message: |
      Validate architecture document against current codebase?

      This will:
      - Check for drift between documented architecture and implementation
      - Update the architecture doc if needed

      Run architecture validation?
    inputType: confirm

  # architectureValidation - Run architecture validation
  - id: architectureValidation
    type: shell
    needs: [promptArchitectureValidation]
    if: ${{ steps.promptArchitectureValidation.output == true }}
    allowInsecure: true
    run: |
      claude -p "/bmad-bmm-create-architecture - Validate the current architecture document against the actual codebase for epic ${{ inputs.epic_id }}. Identify any drift between documented architecture and implementation. Update the architecture doc if needed. Do not ask questions." --dangerously-skip-permissions

  # promptImplementationReadiness - Implementation readiness check (optional)
  - id: promptImplementationReadiness
    type: human
    needs: [architectureValidation]
    if: ${{ steps.confirmStart.output == true }}
    message: |
      Run implementation readiness check?

      This validates that the PRD, epics, and UX design are properly aligned
      before starting story implementation.
    inputType: confirm

  # implementationReadiness - Run implementation readiness check
  - id: implementationReadiness
    type: human
    needs: [promptImplementationReadiness]
    if: ${{ steps.promptImplementationReadiness.output == true }}
    message: |
      Please run the implementation readiness check in another terminal:
        claude "/bmad-bmm-check-implementation-readiness"

      Review the output and confirm when complete.
    inputType: confirm

  # promptCourseCorrection - Course correction (optional)
  - id: promptCourseCorrection
    type: human
    needs: [implementationReadiness]
    if: ${{ steps.confirmStart.output == true }}
    message: |
      Run course correction before proceeding to stories?

      This helps identify and fix misalignments discovered during readiness checks.
    inputType: confirm

  # courseCorrection - Run course correction
  - id: courseCorrection
    type: human
    needs: [promptCourseCorrection]
    if: ${{ steps.promptCourseCorrection.output == true }}
    message: |
      Please run course correction in another terminal:
        claude "/bmad-bmm-correct-course"

      Review the output, apply any recommended changes, and confirm when complete.
    inputType: confirm

  # processStory - Process each story using native foreach
  - id: processStory
    type: workflow
    needs: [courseCorrection]
    if: ${{ steps.confirmStart.output == true }}
    foreach: ${{ steps.loadStories.output }}
    concurrency: 1
    path: bmad-story.yaml
    inputs:
      story_id: ${{ item }}
      use_tea: ${{ inputs.use_tea }}

  # promptArchitectureRefresh - Architecture refresh (optional)
  - id: promptArchitectureRefresh
    type: human
    needs: [processStory]
    if: ${{ steps.confirmStart.output == true }}
    message: |
      All stories for Epic ${{ inputs.epic_id }} have been processed.

      Refresh the architecture document to reflect changes made during the epic?
    inputType: confirm

  # architectureRefresh - Refresh architecture document
  - id: architectureRefresh
    type: human
    needs: [promptArchitectureRefresh]
    if: ${{ steps.promptArchitectureRefresh.output == true }}
    message: |
      Please refresh the architecture document in another terminal:
        claude "/bmad-bmm-create-architecture"

      This ensures the architecture doc reflects all changes made during the epic.
      Confirm when complete.
    inputType: confirm

  # prepareSummaryData - Prepare summary data
  - id: prepareSummaryData
    type: shell
    needs: [architectureRefresh]
    if: ${{ steps.confirmStart.output == true }}
    allowInsecure: true
    run: |
      TMPFILE=$(mktemp /tmp/keystone-summary.XXXXXX.json)
      if [ -z "$TMPFILE" ]; then
        printf "Error: Failed to create temporary file\n" >&2
        exit 1
      fi
      cat > "$TMPFILE" << 'JSONEOF'
      {"results": ${{ steps.processStory.output }}, "stories": ${{ steps.loadStories.output }}}
      JSONEOF
      printf '%s' "$TMPFILE"

  # generateSummary - Generate summary report
  - id: generateSummary
    type: script
    needs: [prepareSummaryData]
    if: ${{ steps.confirmStart.output == true }}
    allowInsecure: true
    run: |
      const fs = require("fs");
      const tmpFile = "${{ steps.prepareSummaryData.output }}";
      if (!fs.existsSync(tmpFile)) {
        return { total: 0, successful: 0, failed: 0, details: "Summary data not found." };
      }
      const data = JSON.parse(fs.readFileSync(tmpFile, "utf8"));
      fs.unlinkSync(tmpFile);
      const results = data.results || [];
      const stories = data.stories || [];

      let successful = 0;
      let failed = 0;
      const details = [];

      for (let i = 0; i < stories.length; i++) {
        const storyId = stories[i];
        const result = results[i] || {};
        const success = result.success !== false;

        if (success) {
          successful++;
          details.push(`✅ ${storyId}: ${result.commit_state || 'completed'}`);
        } else {
          failed++;
          details.push(`❌ ${storyId}: ${result.error || 'failed'}`);
        }
      }

      return {
        total: stories.length,
        successful,
        failed,
        details: details.join('\n')
      };

  # summary - Display summary and confirm
  - id: summary
    type: human
    needs: [generateSummary]
    if: ${{ steps.confirmStart.output == true }}
    message: |
      ══════════════════════════════════════════════════════════════
      Epic ${{ inputs.epic_id }} Processing Complete
      ══════════════════════════════════════════════════════════════

      Stories: ${{ steps.generateSummary.output.total }} total
        ✅ Successful: ${{ steps.generateSummary.output.successful }}
        ❌ Failed: ${{ steps.generateSummary.output.failed }}

      Results:
      ${{ steps.generateSummary.output.details }}

      ══════════════════════════════════════════════════════════════

      Continue to retrospective?
    inputType: confirm

  # preRetroExtraction - Scan story files for unresolved items before retrospective
  - id: preRetroExtraction
    type: shell
    needs: [summary]
    if: ${{ steps.summary.output == true }}
    allowInsecure: true
    run: |
      claude -p "Scan all story files for epic ${{ inputs.epic_id }} in _bmad-output/implementation-artifacts/ (files matching pattern ${{ inputs.epic_id }}-*.md, excluding retro and followup files). Extract unresolved items from these categories:

      1. UNRESOLVED REVIEW RECOMMENDATIONS: Look in Code Review sections for recommendations marked 'Not Fixed', 'future work', 'follow-up', or 'out of scope'. Extract each deferred recommendation.

      2. DEV NOTE IDEAS: Look in Dev Notes / Implementation Notes sections for ideas or suggestions not implemented — phrases like 'could also', 'might want to', 'future improvement', 'consider'.

      3. DEBUG LOG OBSERVATIONS: Look in Debug Log sections for workarounds that should be revisited, unexpected behaviors not fully resolved, or notes about flaky tests.

      4. TODO/FIXME ITEMS: Scan entire story files for TODO, FIXME, HACK, WORKAROUND, or unchecked task items (- [ ]) in completed stories.

      After scanning, check the existing FUTURE WORK / BACKLOG IDEAS section in ${{ inputs.sprint_status_path }} and skip any items already tracked there.

      For each NEW item found, append it to the FUTURE WORK / BACKLOG IDEAS comment section at the end of ${{ inputs.sprint_status_path }} using this format:
      # [component] Brief description
      #   Context: Source story and section. One-sentence explanation.
      #   Trigger: When this should be addressed.

      Preserve ALL existing content and comments in sprint-status.yaml. Report what was found and added. Do not ask questions." --dangerously-skip-permissions

  # retrospective - Retrospective (user runs interactively)
  - id: retrospective
    type: human
    needs: [preRetroExtraction]
    if: ${{ steps.summary.output == true }}
    message: |
      Time for Epic ${{ inputs.epic_id }} retrospective.

      Please run in another terminal:
        claude "/bmad-bmm-retrospective - Epic ${{ inputs.epic_id }}"

      Confirm when complete.
    inputType: confirm
