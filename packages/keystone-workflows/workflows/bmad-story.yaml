$schema: https://raw.githubusercontent.com/mhingston/keystone-cli/main/schemas/workflow.json
name: bmad-story
description: "BMAD single-story workflow: dev-story → code-review (gemini) → code-review (claude) → verify → commit"

inputs:
  story_id:
    type: string
    description: "Story ID to process (e.g., '3c-1')"
  use_tea:
    type: boolean
    default: false
    description: "Enable TEA (Test-Evidence-Architecture) steps: ATDD acceptance test design, post-dev test quality review, and traceability checks"

outputs:
  success: ${{ steps.postCommit.exitCode == 0 }}
  story_id: ${{ inputs.story_id }}
  preflight_state: ${{ steps.preflight.output }}
  commit_state: ${{ steps.postCommit.output }}

steps:
  # Note: Timeouts removed - stories can take over an hour and timeout+retry can cause issues
  # with agent state. Better to let long-running steps complete naturally.

  # preflight - Record initial git state
  - id: preflight
    type: shell
    allowInsecure: true
    run: |
      # Verify we're in a git repository
      if ! git rev-parse --git-dir >/dev/null 2>&1; then
        printf "Error: Not in a git repository\n" >&2
        exit 1
      fi

      # Get dirty file count
      if ! GIT_OUTPUT=$(git status --porcelain 2>&1); then
        printf "Error: git status failed: %s\n" "$GIT_OUTPUT" >&2
        exit 1
      fi

      DIRTY_FILES=$(printf '%s' "$GIT_OUTPUT" | wc -l | tr -d ' ')
      if [ "$DIRTY_FILES" -gt 0 ]; then
        printf "⚠️  Warning: Working directory has %s uncommitted file(s):\n" "$DIRTY_FILES" >&2
        git status --porcelain >&2
        printf "\n" >&2
        printf "These files existed before workflow started.\n" >&2
        printf "dirty:%s" "$DIRTY_FILES"
      else
        printf "clean:0"
      fi

  # acceptanceTestDesign - Design acceptance tests (TEA/ATDD)
  - id: acceptanceTestDesign
    type: shell
    needs: [preflight]
    if: ${{ inputs.use_tea == true }}
    allowInsecure: true
    run: |
      claude -p "/bmad-tea-testarch-atdd - Generate failing acceptance tests for story ${{ inputs.story_id }}. Design tests based on acceptance criteria before implementation begins. Do not ask questions." --dangerously-skip-permissions

  # devStory - Develop the story using Claude Code CLI
  - id: devStory
    needs: [acceptanceTestDesign]
    type: shell
    allowInsecure: true
    run: |
      claude -p "/bmad-bmm-dev-story - Work on story: ${{ inputs.story_id }}. Complete all tasks. Run tests after each implementation. Do not ask clarifying questions - use best judgment based on existing patterns. Do not commit any changes." --dangerously-skip-permissions

  # testReview - Review test quality and completeness (TEA)
  - id: testReview
    type: shell
    needs: [devStory]
    if: ${{ inputs.use_tea == true }}
    allowInsecure: true
    run: |
      claude -p "/bmad-tea-testarch-test-review - Review tests for story ${{ inputs.story_id }}. Scope: directory. Check for missing test layers, DI contract verification, and acceptance criteria coverage. Do not ask questions." --dangerously-skip-permissions

  # reviewGemini - Code review with Gemini CLI
  - id: reviewGemini
    type: shell
    needs: [testReview]
    allowInsecure: true
    run: |
      gemini "/bmad-bmm-code-review - Review story: ${{ inputs.story_id }}. When presenting fix options, always choose to auto-fix all issues immediately. Do not wait for user input. Do not commit any changes. Do not modify acceptance test files generated by the ATDD step." --yolo

  # reviewClaude - Code review with Claude CLI
  - id: reviewClaude
    type: shell
    needs: [reviewGemini]
    allowInsecure: true
    run: |
      claude -p "/bmad-bmm-code-review - Review story: ${{ inputs.story_id }}. When presenting fix options, always choose to auto-fix all issues immediately. Do not wait for user input. Do not commit any changes. Do not modify acceptance test files generated by the ATDD step." --dangerously-skip-permissions

  # traceabilityCheck - Verify traceability (TEA)
  - id: traceabilityCheck
    type: shell
    needs: [reviewClaude]
    if: ${{ inputs.use_tea == true }}
    allowInsecure: true
    run: |
      claude -p "/bmad-tea-testarch-trace - Verify implementation of story ${{ inputs.story_id }} satisfies ATDD acceptance criteria. Check traceability from acceptance tests to implementation. Do not ask questions." --dangerously-skip-permissions

  # verify - Verify tests pass
  - id: verify
    type: shell
    needs: [traceabilityCheck]
    allowInsecure: true
    run: |
      claude -p "/bmad-bmm-quick-dev - Verify tests pass for story ${{ inputs.story_id }}. Run all tests and fix any failures. Do not ask questions. Do not commit any changes." --dangerously-skip-permissions

  # checkChanges - Check if there are changes to commit
  - id: checkChanges
    type: shell
    needs: [verify]
    allowInsecure: true
    run: |
      if git diff --quiet && git diff --cached --quiet; then
        printf "no_changes"
      else
        printf "has_changes"
      fi

  # commit - Commit changes (skip if no changes)
  - id: commit
    type: shell
    needs: [checkChanges]
    if: ${{ steps.checkChanges.output != 'no_changes' }}
    allowInsecure: true
    run: |
      claude -p "/git-workflow:commit - Commit implementation for story ${{ inputs.story_id }}. Stage all relevant changes and commit with a descriptive message. Do not ask for confirmation." --dangerously-skip-permissions

  # postCommit - Post-commit verification
  - id: postCommit
    type: shell
    needs: [commit]
    allowInsecure: true
    run: |
      # Handle "no changes" case
      if [ "${{ steps.checkChanges.output }}" = "no_changes" ]; then
        printf "ℹ️  No changes to commit - story already complete or no modifications made\n" >&2
        printf "ok:no_changes"
        exit 0
      fi

      # Check for any uncommitted changes after commit
      UNCOMMITTED=$(git status --porcelain 2>/dev/null)
      if [ -n "$UNCOMMITTED" ]; then
        printf "⚠️  Uncommitted changes detected after commit:\n" >&2
        printf "%s\n" "$UNCOMMITTED" >&2
        printf "\n" >&2
        # Extract pre-workflow dirty count from preflight output
        PREFLIGHT_STATE="${{ steps.preflight.output }}"
        PRE_DIRTY=$(printf '%s' "$PREFLIGHT_STATE" | cut -d: -f2)
        POST_DIRTY=$(printf '%s' "$UNCOMMITTED" | wc -l | tr -d ' ')

        if [ "$POST_DIRTY" -gt "$PRE_DIRTY" ]; then
          NEW_FILES=$((POST_DIRTY - PRE_DIRTY))
          printf "❌ %s new uncommitted file(s) created during workflow!\n" "$NEW_FILES" >&2
          printf "These should be reviewed and either committed or added to .gitignore\n" >&2
          exit 1
        else
          printf "ℹ️  These files existed before workflow started (pre-existing dirty state)\n" >&2
          printf "warn:pre_existing_dirty"
        fi
      else
        printf "✅ All changes committed successfully\n" >&2
        printf "ok:clean"
      fi

  # summary - Story completion summary
  - id: summary
    type: shell
    needs: [postCommit]
    allowInsecure: true
    run: |
      printf "══════════════════════════════════════════════════════════════\n"
      printf "Story %s processing complete.\n" "${{ inputs.story_id }}"
      printf "══════════════════════════════════════════════════════════════\n"
      printf "\n"
      printf "Pre-flight: %s\n" "${{ steps.preflight.output }}"
      printf "\n"
      printf "Steps completed:\n"
      if [ "${{ inputs.use_tea }}" = "true" ]; then
        printf "  - acceptanceTestDesign (TEA/ATDD): ✓\n"
      fi
      printf "  - devStory: ✓\n"
      if [ "${{ inputs.use_tea }}" = "true" ]; then
        printf "  - testReview (TEA): ✓\n"
      fi
      printf "  - reviewGemini: ✓\n"
      printf "  - reviewClaude: ✓\n"
      if [ "${{ inputs.use_tea }}" = "true" ]; then
        printf "  - traceabilityCheck (TEA): ✓\n"
      fi
      printf "  - verify: ✓\n"
      if [ "${{ steps.checkChanges.output }}" = "no_changes" ]; then
        printf "  - commit: skipped (no changes)\n"
      else
        printf "  - commit: ✓\n"
      fi
      printf "\n"
      printf "Post-commit: %s\n" "${{ steps.postCommit.output }}"
      printf "══════════════════════════════════════════════════════════════\n"
